<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>fringes.decoder &mdash; Fringes  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            Fringes
          </a>
              <div class="version">
                0.2.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Fringes</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">fringes.decoder</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for fringes.decoder</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>

<span class="n">PI2</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>


<div class="viewcode-block" id="circ_dist"><a class="viewcode-back" href="../../fringes.html#fringes.decoder.circ_dist">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">circ_dist</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shortest circular distance from a to b.</span>
<span class="sd">    param a: start point</span>
<span class="sd">    param b: end point</span>
<span class="sd">    param c: circumference (distance) after which wrapping occurs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">dmax</span> <span class="o">=</span> <span class="n">c</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># return dmax - np.abs(dmax - d)</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">&gt;</span> <span class="n">dmax</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">-=</span> <span class="n">c</span>
    <span class="k">elif</span> <span class="n">d</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">dmax</span><span class="p">:</span>
        <span class="n">d</span> <span class="o">+=</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">d</span></div>


<span class="c1"># @nb.jit(cache=True, nopython=True, nogil=True, fastmath=True)</span>
<div class="viewcode-block" id="decode"><a class="viewcode-back" href="../../fringes.html#fringes.decoder.decode">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">jit</span><span class="p">(</span><span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nogil</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># @nb.jit(</span>
<span class="c1">#     nb.types.UniTuple(  # output types</span>
<span class="c1">#         nb.float32[:, :, :, :],</span>
<span class="c1">#         6</span>
<span class="c1">#     )</span>
<span class="c1">#     (  # input types</span>
<span class="c1">#         nb.uint8[:, :, :, :],</span>
<span class="c1">#         nb.int_[:, :],</span>
<span class="c1">#         nb.float64[:, :],</span>
<span class="c1">#         nb.float64[:, :],</span>
<span class="c1">#         nb.int_[:],</span>
<span class="c1">#         nb.float64,</span>
<span class="c1">#         nb.float64,</span>
<span class="c1">#         nb.float64,</span>
<span class="c1">#         nb.types.unicode_type,</span>
<span class="c1">#         nb.float64,</span>
<span class="c1">#         nb.bool_,</span>
<span class="c1">#     ),</span>
<span class="c1">#     cache=True, nopython=True, nogil=True, parallel=True, fastmath=True)</span>
<span class="k">def</span> <span class="nf">decode</span><span class="p">(</span>
    <span class="n">I</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">N</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">f</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">R</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="c1"># range</span>
    <span class="n">a</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># alpha</span>
    <span class="n">o</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="n">r</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">mode</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">Vmin</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># 10 / 255  # min fringe contrast i.e. min visibility (can accelerate unwrapping)</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decoding.&quot;&quot;&quot;</span>

    <span class="c1"># assertions</span>
    <span class="k">assert</span> <span class="n">I</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;Image sequence must be in video shape (T, Y, X, C).&quot;</span>
    <span class="k">assert</span> <span class="n">N</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;N, v, f each must have two dimensions.&quot;</span>
    <span class="k">assert</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">v</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">f</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;N, v, f each must have same shape (D, K).&quot;</span>
    <span class="k">assert</span> <span class="kc">False</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Nd</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">Nd</span> <span class="ow">in</span> <span class="n">N</span><span class="p">],</span> <span class="s2">&quot;Each direction must have at least one set with &gt;= 3 shifts.&quot;</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">I</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">==</span> <span class="n">T</span><span class="p">,</span> <span class="s2">&quot;Sum of shifts must equal number of frames.&quot;</span>
    <span class="n">D</span><span class="p">,</span> <span class="n">K</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">assert</span> <span class="n">R</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">D</span><span class="p">,</span> <span class="s2">&quot;Screen length must be given for each direction.&quot;</span>

    <span class="n">L</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="n">a</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">L</span> <span class="o">/</span> <span class="n">v</span>  <span class="c1"># lambda i.e. period lengths in [px]</span>

    <span class="c1"># precomputations for later use in for-loops</span>
    <span class="n">Nmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    <span class="n">sin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Nmax</span><span class="p">))</span>  <span class="c1"># phase shift factors</span>
    <span class="n">cos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Nmax</span><span class="p">))</span>  <span class="c1"># phase shift factors</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]):</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">4</span> <span class="k">if</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="k">else</span> <span class="n">n</span> <span class="o">/</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>  <span class="c1"># todo: variable/individual t as in Uni-PSA-Gen</span>
                <span class="n">wto</span> <span class="o">=</span> <span class="n">PI2</span> <span class="o">*</span> <span class="n">f</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="n">t</span>
                <span class="n">sin</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">wto</span><span class="p">)</span>
                <span class="n">cos</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">wto</span><span class="p">)</span>

    <span class="c1"># time/frame indices for when decoding shifts of each set</span>
    <span class="n">Nacc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
    <span class="n">N0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="n">Nacc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]]])[:</span><span class="n">D</span><span class="p">]</span>
    <span class="n">ti</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">N0</span><span class="p">,</span> <span class="n">Nacc</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>  <span class="c1"># indices for traversing t</span>

    <span class="c1"># check if N contains ones or twos</span>
    <span class="n">KN1</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)]</span>  <span class="c1"># k-indices where N == 1</span>
    <span class="n">KN2</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)]</span>  <span class="c1"># k-indices where N == 2</span>
    <span class="n">KN3</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="k">if</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)]</span>  <span class="c1"># k-indices where N &gt;= 3</span>
    <span class="n">EN1</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Nd</span><span class="p">[</span><span class="n">Nd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">Nd</span> <span class="ow">in</span> <span class="n">N</span><span class="p">]</span>  <span class="c1"># number of sets where N == 1</span>
    <span class="n">EN11</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Nd</span><span class="p">[</span><span class="n">Nd</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">Nd</span> <span class="ow">in</span> <span class="n">N</span>
    <span class="p">]</span>  <span class="c1"># EN1 plus one, since we compare all shifts with N == 1 to one with N &gt;= 3</span>
    <span class="n">EN3</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Nd</span><span class="p">[</span><span class="n">Nd</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">])</span> <span class="k">for</span> <span class="n">Nd</span> <span class="ow">in</span> <span class="n">N</span><span class="p">]</span>  <span class="c1"># number of sets where N &gt;= 3</span>

    <span class="c1"># choose that v from which the other fringe orders of the remaining sets are derived</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;precise&quot;</span><span class="p">:</span>  <span class="c1"># todo: decide for each pixel individually i.e. multiply with B later on</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># weights of phase measurements are their inverse variances (must be multiplied with B later on)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)]</span>  <span class="c1"># the set with most precise phases</span>
    <span class="c1"># elif mode == &quot;robust&quot;:  # todo: &quot;exhaustive&quot;?</span>
    <span class="c1">#     NotImplemented  # todo: try neighboring fringe orders / all permutations = exhaustive search?</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># fast (fallback)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int_</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">v</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
        <span class="p">]</span>  <span class="c1"># the set with the least number of periods</span>
    <span class="n">Ki</span> <span class="o">=</span> <span class="p">[[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">K</span><span class="p">)</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)]</span>  <span class="c1"># indices of v without idx</span>

    <span class="c1"># usually, camera sees only part of/center of the screen</span>
    <span class="c1"># -&gt; try central fringe orders first and move outwards</span>
    <span class="c1"># (this only accelerates if break criterion is used and reached)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">R</span> <span class="o">/</span> <span class="n">L</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span> <span class="o">*</span> <span class="n">scale</span><span class="p">[</span><span class="n">d</span><span class="p">]))</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)</span>
    <span class="p">]</span>  <span class="c1"># max number periods of v[:, idx] in each direction</span>
    <span class="c1"># vi = [[(vmax[d] - 1) // 2 + [-1, +1][i % 2] * ((i + 1) // 2) for i in range(vmax[d])] for d in range(D)]  # indices for traversing v from the center outwards</span>
    <span class="c1"># vi = [[(vmax[d] + [~i, i][i % 2]) // 2 for i in range(vmax[d])] for d in range(D)]  # indices for traversing v from the center outwards</span>
    <span class="n">vi</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">vmax</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">~</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">][</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">])</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vmax</span><span class="p">[</span><span class="n">d</span><span class="p">])])</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">)]</span>

    <span class="c1"># starting value for TPU solver based on maximum length R[d] and Popoviciu&#39;s inequality on variances</span>
    <span class="n">varmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>  <span class="c1"># Popoviciu&#39;s inequality on variances</span>
    <span class="n">ssdmax</span> <span class="o">=</span> <span class="n">varmax</span> <span class="o">*</span> <span class="n">K</span>

    <span class="c1"># convergence limit for TPU solver based on smallest allowed residual r (based on estimated SNR)</span>
    <span class="c1"># r = l[range(D), idx] / 2</span>
    <span class="c1"># r = 1  # range of interval</span>

    <span class="n">varlim</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">ssdlim</span> <span class="o">=</span> <span class="n">varlim</span> <span class="o">*</span> <span class="n">K</span>

    <span class="c1"># allocate</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span>  <span class="c1"># float32&#39;s precision is usually better than quantization noise in phase shifting sequence</span>
    <span class="n">bri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>  <span class="c1"># brightness must be identical for all sets, therefore we arverage over them</span>
    <span class="n">mod</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">D</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">dt</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>  <span class="c1"># usually X &gt; Y -&gt; put X first, because parallelization only affects outer for-loop</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">nb</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="n">Y</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">D</span><span class="p">):</span>
                    <span class="c1"># temporal demodulation</span>
                    <span class="n">A</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">KN3</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># where N &gt;= 3</span>
                        <span class="n">re</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">ti</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">],</span> <span class="n">ti</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])):</span>
                            <span class="n">A</span> <span class="o">+=</span> <span class="n">I</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
                            <span class="n">re</span> <span class="o">+=</span> <span class="n">I</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">cos</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
                            <span class="n">im</span> <span class="o">+=</span> <span class="n">I</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">sin</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
                        <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">re</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">im</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
                        <span class="p">)</span>  <span class="c1"># factor of two because we also have to add the amplitudes of the frequencies with opposite sign</span>
                        <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">re</span><span class="p">)</span>  <span class="c1"># arctan maps to [-PI, PI]</span>
                    <span class="n">A</span> <span class="o">/=</span> <span class="n">EN3</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">KN2</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># where N == 2</span>
                        <span class="n">t1</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                        <span class="n">t2</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">re</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">t1</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">t2</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span>
                        <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">re</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">im</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># / N[d, k] * 2 is obsolete because == 1</span>
                        <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">re</span><span class="p">)</span>  <span class="c1"># arctan maps to [-PI, PI]</span>

                    <span class="k">if</span> <span class="n">EN1</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># if 1 in N</span>
                        <span class="n">m_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">B</span><span class="p">[</span><span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">KN1</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># where N == 1</span>
                            <span class="n">t</span> <span class="o">=</span> <span class="n">ti</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span>
                            <span class="c1"># arg = min(max(-1, (I[t, y, x, c] - A) / m_avg), 1)  # todo: clipping necessary?</span>
                            <span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">-</span> <span class="n">A</span><span class="p">)</span> <span class="o">/</span> <span class="n">m_avg</span>
                            <span class="n">B</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="n">p</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># arccos maps [-1, 1] to [0, PI]</span>

                    <span class="n">bri</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">A</span>
                    <span class="n">mod</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="p">:,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">B</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">phi</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="p">:,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>

                    <span class="c1"># spatial demodulation i.e. unwrapping</span>
                    <span class="c1"># todo: reg, res = unwrap()</span>
                    <span class="k">if</span> <span class="n">K</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># no spatial modulation</span>
                            <span class="k">if</span> <span class="n">R</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">reg</span><span class="p">[</span>
                                    <span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span>
                                <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># the only possible value; however this is obsolete as it makes no senso to encode one single coordinate</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                                    <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">reg</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># no spatial modulation, therefore we can&#39;t compute value</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                                    <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                        <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># one period covers whole screen: no unwrapping required</span>
                            <span class="n">pn</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">o</span><span class="p">)</span> <span class="o">/</span> <span class="n">PI2</span> <span class="o">%</span> <span class="mi">1</span>
                            <span class="p">)</span>  <span class="c1"># revert offset and change codomain from [-PI, PI] to [0, 1) -&gt; normalized phi</span>
                            <span class="n">reg</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">pn</span> <span class="o">*</span> <span class="n">l</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># todo: uncertainty</span>
                                <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="k">else</span><span class="p">:</span>  <span class="c1"># spatial phase unwrapping (to be done in a later step)</span>
                            <span class="n">reg</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="c1"># todo: residuals are to be received from SPU (spatial phase unwrapping)</span>
                                <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># unknown</span>
                    <span class="k">else</span><span class="p">:</span>  <span class="c1"># K &gt; 1: temporal phase unwrapping</span>
                        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>  <span class="c1"># todo</span>
                            <span class="c1"># cw = np.empty(K)  # fringe visibility (fringe contrast) squared for multiplying into weights</span>
                            <span class="c1">#                         # for k in range(K):  # softmax?</span>
                            <span class="c1">#                         #     if B[k] &gt; 2 * A[k]:</span>
                            <span class="c1">#                         #         cm[k] = 0</span>
                            <span class="c1">#                         #     elif B[k] &gt; A[k]:</span>
                            <span class="c1">#                         #         cw[k] = np.sqrt(2 - B[k])  # (2 - B[k]) ** (1 / p)  # 1</span>
                            <span class="c1">#                         #     else:</span>
                            <span class="c1">#                         #         cw[k] = (B[k] / A[k]) ** 2</span>
                            <span class="n">v</span> <span class="o">=</span> <span class="n">A</span> <span class="o">/</span> <span class="n">B</span>  <span class="c1"># dim K ?!</span>
                            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">v</span> <span class="o">&lt;</span> <span class="n">Vmin</span> <span class="ow">or</span> <span class="n">B</span> <span class="o">&gt;</span> <span class="n">A</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
                            <span class="p">)</span>  <span class="c1"># check for sufficient modulation i.e. fringe contrast</span>
                            <span class="c1"># todo: if umr(v[mask]) &lt; R -&gt; SPU</span>
                            <span class="c1">#     reg[d, y, x, c] = np.nan</span>
                            <span class="c1"># if verbose:</span>
                            <span class="c1">#   pass  # residuals are to be received from SPU (spatial phase unwrapping)</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">mn</span> <span class="o">=</span> <span class="n">ssdmax</span><span class="p">[</span><span class="n">d</span><span class="p">]</span> <span class="o">+</span> <span class="mi">0</span>  <span class="c1"># adding zero creates a copy</span>
                            <span class="n">pn</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">p</span> <span class="o">%</span> <span class="n">PI2</span> <span class="o">+</span> <span class="n">o</span>
                            <span class="p">)</span> <span class="o">/</span> <span class="n">PI2</span>  <span class="c1"># change codomain from [-PI, PI] to [-0.5, 0.5) and revert offset -&gt; normalized phi</span>
                            <span class="c1"># pn = (p + o) / PI2  # change codomain from [-PI, PI] to [-0.5, 0.5] and revert offset -&gt; normalized phi</span>
                            <span class="n">pn</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">%</span> <span class="n">PI2</span> <span class="o">+</span> <span class="n">o</span><span class="p">)</span> <span class="o">/</span> <span class="n">PI2</span> <span class="o">%</span> <span class="mi">1</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">vi</span><span class="p">[</span>
                                <span class="n">d</span>
                            <span class="p">]:</span>  <span class="c1"># fringe orders of fringe set &#39;idx&#39;  # todo: start from fringe order given by CRT: move those to the beginning of vi</span>
                                <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">pn</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">]])</span> <span class="o">*</span> <span class="n">l</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">]]</span>  <span class="c1"># position for phase and i-th fringe order</span>
                                <span class="nb">sum</span> <span class="o">=</span> <span class="n">xi</span>
                                <span class="n">ssd</span> <span class="o">=</span> <span class="n">xi</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># sum of squared distances</span>

                                <span class="k">if</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="n">sum2</span> <span class="o">=</span> <span class="nb">sum</span> <span class="o">+</span> <span class="mi">0</span>  <span class="c1"># adding zero creates a copy</span>
                                    <span class="n">ssd2</span> <span class="o">=</span> <span class="n">ssd</span> <span class="o">+</span> <span class="mi">0</span>  <span class="c1"># adding zero creates a copy</span>

                                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Ki</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># indices of v without idx</span>
                                    <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                        <span class="n">xi</span> <span class="o">/</span> <span class="n">l</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">pn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
                                    <span class="p">)</span>  <span class="c1"># fringe order of k-th fringe set  # todo: also try neighboring fringe orders (if phase is close to them ~ phimax / 2)</span>
                                    <span class="n">xj</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">pn</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="o">*</span> <span class="n">l</span><span class="p">[</span>
                                        <span class="n">d</span><span class="p">,</span> <span class="n">k</span>
                                    <span class="p">]</span>  <span class="c1"># position for phase and j-th fringe order  # todo: Verschiebungssatz AND weighted average compatible?</span>
                                    <span class="nb">sum</span> <span class="o">+=</span> <span class="n">xj</span>
                                    <span class="n">ssd</span> <span class="o">+=</span> <span class="n">xj</span><span class="o">**</span><span class="mi">2</span>

                                    <span class="k">if</span> <span class="n">N</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">xj2</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pn</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span> <span class="o">*</span> <span class="n">l</span><span class="p">[</span>
                                            <span class="n">d</span><span class="p">,</span> <span class="n">k</span>
                                        <span class="p">]</span>  <span class="c1"># position for phase and j2-th fringe order #  todo: Verschiebungssatz AND weighted average compatible?</span>
                                        <span class="n">sum2</span> <span class="o">+=</span> <span class="n">xj2</span>
                                        <span class="n">ssd2</span> <span class="o">+=</span> <span class="n">xj2</span><span class="o">**</span><span class="mi">2</span>

                                <span class="n">ssd</span> <span class="o">-=</span> <span class="nb">sum</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">K</span>  <span class="c1"># Verschiebungssatz i.e. Steiner&#39;s theorem</span>

                                <span class="k">if</span> <span class="n">ssd</span> <span class="o">&lt;</span> <span class="n">mn</span><span class="p">:</span>
                                    <span class="n">mn</span> <span class="o">=</span> <span class="n">ssd</span>
                                    <span class="n">avg</span> <span class="o">=</span> <span class="nb">sum</span> <span class="o">/</span> <span class="n">K</span>
                                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                        <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Ki</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># indices of v without idx</span>
                                            <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                                <span class="n">xi</span> <span class="o">/</span> <span class="n">l</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">pn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
                                            <span class="p">)</span>  <span class="c1"># fringe order of k-th fringe set  # todo: also try neighboring fringe orders (if phase is close to them ~ phimax / 2)</span>

                                    <span class="k">if</span> <span class="n">mn</span> <span class="o">&lt;=</span> <span class="n">ssdlim</span><span class="p">:</span>
                                        <span class="k">break</span>

                                <span class="k">if</span> <span class="n">EN1</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># 1 in N[d]</span>
                                    <span class="n">ssd2</span> <span class="o">-=</span> <span class="n">sum2</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">EN11</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>  <span class="c1"># Verschiebungssatz i.e. Steiner&#39;s theorem</span>

                                    <span class="k">if</span> <span class="n">ssd2</span> <span class="o">&lt;</span> <span class="n">mn</span><span class="p">:</span>
                                        <span class="n">mn</span> <span class="o">=</span> <span class="n">ssd2</span>
                                        <span class="n">avg</span> <span class="o">=</span> <span class="n">sum2</span> <span class="o">/</span> <span class="n">EN11</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
                                        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                            <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">idx</span><span class="p">[</span><span class="n">d</span><span class="p">],</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Ki</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>  <span class="c1"># indices of v without idx</span>
                                                <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                                    <span class="n">xi</span> <span class="o">/</span> <span class="n">l</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="n">pn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span>
                                                <span class="p">)</span>  <span class="c1"># fringe order of k-th fringe set  # todo: also try neighboring fringe orders (if phase is close to them ~ phimax / 2)</span>

                                        <span class="k">if</span> <span class="n">mn</span> <span class="o">&lt;=</span> <span class="n">ssdlim</span><span class="p">:</span>
                                            <span class="k">break</span>

                            <span class="k">if</span> <span class="n">mn</span> <span class="o">&gt;=</span> <span class="n">ssdmax</span><span class="p">[</span><span class="n">d</span><span class="p">]:</span>
                                <span class="n">reg</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># np.nan  # no suitable fringe orders found</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">L</span> <span class="o">/</span> <span class="mi">2</span>
                                    <span class="p">)</span>  <span class="c1"># no suitable fringe orders found -&gt; set max value possible due to Popoviciu&#39;s inequality on variances</span>
                                    <span class="n">fid</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="p">:,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># no suitable fringe orders found</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">reg</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">avg</span>
                                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                    <span class="n">res</span><span class="p">[</span><span class="n">d</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mn</span> <span class="o">/</span> <span class="n">K</span><span class="p">)</span>  <span class="c1"># ssd (sum of squared distances) -&gt; std</span>

    <span class="k">return</span> <span class="n">phi</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">bri</span><span class="p">,</span> <span class="n">mod</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">),</span> <span class="n">reg</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">fid</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Christian Kludt.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>